<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard - VS Code Contributors</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <nav>
        <a href="/" class="nav-brand">
            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><mask id="a" mask-type="alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="100" height="100"><path fill-rule="evenodd" clip-rule="evenodd" d="M70.912 99.317a6.85 6.85 0 0 0 4.97-.642l20.159-10.216A6.86 6.86 0 0 0 99.717 82.5V17.5a6.859 6.859 0 0 0-3.676-5.96L75.882 1.325a6.852 6.852 0 0 0-7.81 1.074l-43.34 39.58L10.47 30.32a4.574 4.574 0 0 0-5.833.393L.673 34.542a4.573 4.573 0 0 0-.005 6.588l12.36 11.345L.668 63.82a4.573 4.573 0 0 0 .005 6.588l3.964 3.83a4.573 4.573 0 0 0 5.833.392l14.261-11.66 43.34 39.582a6.844 6.844 0 0 0 2.841 1.765ZM75.025 27.18 45.011 50l30.014 22.82V27.18Z" fill="#fff"/></mask><g mask="url(#a)"><path d="M96.041 11.54 75.882 1.325a6.856 6.856 0 0 0-7.81 1.074L.668 58.862a4.573 4.573 0 0 0 .005 6.588l3.964 3.83a4.573 4.573 0 0 0 5.833.392L96.21 7.124A4.573 4.573 0 0 0 96.04 11.54Z" fill="#0065A9"/><g filter="url(#b)"><path d="M96.041 88.46 75.882 98.675a6.856 6.856 0 0 1-7.81-1.074L.668 41.138a4.573 4.573 0 0 1 .005-6.588l3.964-3.83a4.573 4.573 0 0 1 5.833-.392l85.74 62.548a4.573 4.573 0 0 1-.17 4.584Z" fill="#007ACC"/></g><g filter="url(#c)"><path d="M75.882 98.675A6.849 6.849 0 0 1 68.072 97.6a5.26 5.26 0 0 0 3.602 2.117 5.26 5.26 0 0 0 4.021-1.01l20.16-10.216a6.857 6.857 0 0 0 3.675-5.96V17.5a6.857 6.857 0 0 0-3.676-5.96L75.695 1.326A5.257 5.257 0 0 0 68.072 2.4 6.849 6.849 0 0 1 75.882 1.3l20.16 10.216A6.86 6.86 0 0 1 99.716 17.5v65a6.86 6.86 0 0 1-3.676 5.96l-20.159 10.215Z" fill="#1F9CF0"/></g><g opacity=".25"><path fill-rule="evenodd" clip-rule="evenodd" d="M70.852 99.317a6.851 6.851 0 0 0 4.97-.642l20.159-10.216a6.86 6.86 0 0 0 3.676-5.96V17.5a6.859 6.859 0 0 0-3.676-5.96L75.822 1.326a6.852 6.852 0 0 0-7.81 1.074L24.673 41.98 10.41 30.32a4.574 4.574 0 0 0-5.833.393L.613 34.542a4.573 4.573 0 0 0-.005 6.588l12.36 11.345-12.36 11.345a4.573 4.573 0 0 0 .005 6.588l3.964 3.83a4.573 4.573 0 0 0 5.833.392l14.262-11.66 43.339 39.582a6.845 6.845 0 0 0 2.841 1.765Zm4.113-72.137L44.951 50l30.014 22.82V27.18Z" fill="url(#d)"/></g></g><defs><filter id="b" x="-8.398" y="22.654" width="115.504" height="84.092" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB"><feFlood flood-opacity="0" result="A"/><feColorMatrix in="SourceAlpha" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="B"/><feOffset/><feGaussianBlur stdDeviation="4.167"/><feColorMatrix values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/><feBlend in2="A" result="C"/><feBlend in="SourceGraphic" in2="C"/></filter><filter id="c" x="60.427" y="-6.746" width="47.289" height="113.492" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB"><feFlood flood-opacity="0" result="A"/><feColorMatrix in="SourceAlpha" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="B"/><feOffset/><feGaussianBlur stdDeviation="4.167"/><feColorMatrix values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/><feBlend in2="A" result="C"/><feBlend in="SourceGraphic" in2="C"/></filter><linearGradient id="d" x1="49.948" y1=".823" x2="49.948" y2="99.137" gradientUnits="userSpaceOnUse"><stop stop-color="#fff"/><stop offset="1" stop-color="#fff" stop-opacity="0"/></linearGradient></defs></svg>
            <span>VS Code Contributors</span>
        </a>
        <a href="/" class="nav-link">Home</a>
        <a href="/contributors" class="nav-link">Contributors</a>
        <a href="/leaderboard" class="nav-link active">Leaderboard</a>
        <a href="/ask" class="nav-link">Ask AI</a>
        <a href="/about" class="nav-link">About</a>
        <span class="spacer"></span>
        <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
            <span id="theme-icon">‚òÄÔ∏è</span> <span id="theme-label">Light</span>
        </button>
    </nav>

    <main class="wide">
        <div class="leaderboard-header">
            <h1>Community Leaderboard</h1>
            <p>The most active community contributors across all VS Code releases &mdash; ranked by pull requests merged and releases contributed to.</p>
        </div>

        {{if .Loading}}
        <div class="loading-msg">
            <div class="loading-spinner"></div>
            <p>Fetching contributor data&hellip;</p>
            <p>Please refresh the page in a moment.</p>
        </div>
        {{else}}
        <div class="leaderboard-tabs">
            <a href="/leaderboard?tab=prs" class="leaderboard-tab {{if eq .Tab "prs"}}active{{end}}">
                <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:-2px;margin-right:4px"><path d="M7.177 3.073L9.573.677A.25.25 0 0110 .854v4.792a.25.25 0 01-.427.177L7.177 3.427a.25.25 0 010-.354zM3.75 2.5a.75.75 0 100 1.5.75.75 0 000-1.5zm-2.25.75a2.25 2.25 0 113 2.122v5.256a2.251 2.251 0 11-1.5 0V5.372A2.25 2.25 0 011.5 3.25zM11 2.5h-1V4h1a1 1 0 011 1v5.628a2.251 2.251 0 101.5 0V5A2.5 2.5 0 0011 2.5zm1 10.25a.75.75 0 111.5 0 .75.75 0 01-1.5 0zM3.75 12a.75.75 0 100 1.5.75.75 0 000-1.5z"/></svg>
                Most Pull Requests
            </a>
            <a href="/leaderboard?tab=releases" class="leaderboard-tab {{if eq .Tab "releases"}}active{{end}}">
                <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:-2px;margin-right:4px"><path d="M1 7.775V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.752 1.752 0 011 7.775zM6 5a1 1 0 10-2 0 1 1 0 002 0z"/></svg>
                Most Releases
            </a>
        </div>

        {{if .Entries}}
        <table class="leaderboard-table">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Contributor</th>
                    <th>Pull Requests</th>
                    <th>Releases</th>
                    <th>Celebrate</th>
                </tr>
            </thead>
            <tbody>
                {{range .Entries}}
                <tr>
                    <td class="rank-cell {{if eq .Rank 1}}gold{{else if eq .Rank 2}}silver{{else if eq .Rank 3}}bronze{{end}}">
                        {{if le .Rank 3}}<span class="rank-medal">{{if eq .Rank 1}}ü•á{{else if eq .Rank 2}}ü•à{{else}}ü•â{{end}}</span>{{else}}{{.Rank}}{{end}}
                    </td>
                    <td>
                        <div class="user-cell">
                            <img src="{{.AvatarURL}}" alt="{{.Name}}" class="avatar" loading="lazy">
                            <div class="user-cell-info">
                                <span class="user-cell-name">{{.Name}}</span>
                                <span class="user-cell-handle"><a href="https://github.com/{{.GitHubUser}}" target="_blank" rel="noopener">@{{.GitHubUser}}</a></span>
                            </div>
                        </div>
                    </td>
                    <td><span class="count-badge prs">{{.PRCount}}</span></td>
                    <td><span class="count-badge releases">{{.Releases}}</span></td>
                    <td>
                        <button class="celebrate-btn" onclick="generateCelebration(this, '{{.GitHubUser}}', '{{.Name}}', {{.PRCount}})">
                            üéâ Video
                        </button>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
        {{else}}
        <p>No contributor data available yet.</p>
        {{end}}
        {{end}}
    </main>

    <footer>
        <div class="footer-inner">
            <div class="footer-left">
                <span class="status-dot"></span>
                <span>Built with care</span>
            </div>
            <div class="footer-right">
                Data sourced from <a href="https://code.visualstudio.com/updates" target="_blank" rel="noopener">VS Code Release Notes</a>
            </div>
        </div>
    </footer>

    <script>
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateToggleUI(next);
        }
        function updateToggleUI(theme) {
            document.getElementById('theme-icon').textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            document.getElementById('theme-label').textContent = theme === 'light' ? 'Dark' : 'Light';
        }
        (function() {
            const saved = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
            updateToggleUI(saved);
        })();
    </script>

    <!-- Video Celebration Modal -->
    <div class="video-modal-overlay" id="videoModal">
        <div class="video-modal">
            <button class="video-modal-close" onclick="closeVideoModal()">&times;</button>
            <h2>üéâ Celebration Video</h2>
            <div class="video-modal-content" id="videoModalContent">
                <div class="video-modal-loading">
                    <div class="spinner"></div>
                    <p>Generating your personalized celebration video...</p>
                    <p id="videoStatus">This may take a minute</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let videoPollingInterval = null;

        function openVideoModal() {
            document.getElementById('videoModal').classList.add('active');
        }

        function closeVideoModal() {
            document.getElementById('videoModal').classList.remove('active');
            if (videoPollingInterval) {
                clearInterval(videoPollingInterval);
                videoPollingInterval = null;
            }
        }

        async function generateCelebration(btn, username, contributorName, prCount) {
            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ ...';
            
            openVideoModal();
            document.getElementById('videoModalContent').innerHTML = `
                <div class="video-modal-loading">
                    <div class="spinner"></div>
                    <p>Creating a personalized video for <strong>${contributorName}</strong></p>
                    <p id="videoStatus">Celebrating ${prCount} Pull Requests!</p>
                </div>
            `;

            try {
                const resp = await fetch('/api/celebrate/' + encodeURIComponent(username), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contributor_name: contributorName,
                        milestone: prCount
                    })
                });

                const data = await resp.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                if (data.video_id) {
                    pollVideoStatus(username, data.video_id, btn, contributorName, originalText);
                }
            } catch (e) {
                console.error('Celebration error:', e);
                document.getElementById('videoModalContent').innerHTML = `
                    <div class="video-modal-loading">
                        <p>üòî Sorry, couldn't generate the video.</p>
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">${e.message}</p>
                    </div>
                `;
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function pollVideoStatus(username, videoId, btn, contributorName, originalText) {
            let attempts = 0;
            const maxAttempts = 60;

            videoPollingInterval = setInterval(async () => {
                attempts++;
                
                if (attempts > maxAttempts) {
                    clearInterval(videoPollingInterval);
                    document.getElementById('videoStatus').textContent = 'Video is taking longer than expected...';
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    return;
                }

                try {
                    const resp = await fetch(`/api/celebrate/${encodeURIComponent(username)}?video_id=${videoId}`);
                    const data = await resp.json();

                    if (data.status === 'completed' && data.video_url) {
                        clearInterval(videoPollingInterval);
                        videoPollingInterval = null;
                        
                        document.getElementById('videoModalContent').innerHTML = `
                            <video controls autoplay>
                                <source src="${data.video_url}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            <p style="margin-top: 1rem; color: var(--text-secondary);">
                                Congratulations, ${contributorName}! üéâ
                            </p>
                        `;
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    } else if (data.status === 'failed') {
                        clearInterval(videoPollingInterval);
                        document.getElementById('videoModalContent').innerHTML = `
                            <div class="video-modal-loading">
                                <p>üòî Video generation failed.</p>
                            </div>
                        `;
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    } else {
                        document.getElementById('videoStatus').textContent = `Processing... (${attempts * 5}s)`;
                    }
                } catch (e) {
                    console.error('Poll error:', e);
                }
            }, 5000);
        }

        document.getElementById('videoModal').addEventListener('click', function(e) {
            if (e.target === this) closeVideoModal();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeVideoModal();
        });
    </script>

    <!-- Floating Chat Widget -->
    <button class="chat-widget-trigger" id="chatWidgetTrigger" aria-label="Open AI Assistant">
        <svg class="icon-chat" width="24" height="24" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 0a8 8 0 100 16A8 8 0 008 0zM5.5 4.002h5a.5.5 0 01.5.5v5a.5.5 0 01-.5.5h-2v2.498a.5.5 0 01-.854.354L4.646 9.854A.5.5 0 014.5 9.5v-5a.5.5 0 01.5-.5l.5.002z"/>
        </svg>
        <svg class="icon-close" width="24" height="24" viewBox="0 0 16 16" fill="currentColor">
            <path d="M3.72 3.72a.75.75 0 011.06 0L8 6.94l3.22-3.22a.75.75 0 111.06 1.06L9.06 8l3.22 3.22a.75.75 0 11-1.06 1.06L8 9.06l-3.22 3.22a.75.75 0 01-1.06-1.06L6.94 8 3.72 4.78a.75.75 0 010-1.06z"/>
        </svg>
    </button>

    <div class="chat-widget-panel" id="chatWidgetPanel">
        <div class="chat-widget-header">
            <div class="chat-widget-header-icon">
                <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 0a8 8 0 100 16A8 8 0 008 0zM5.5 4.002h5a.5.5 0 01.5.5v5a.5.5 0 01-.5.5h-2v2.498a.5.5 0 01-.854.354L4.646 9.854A.5.5 0 014.5 9.5v-5a.5.5 0 01.5-.5l.5.002z"/>
                </svg>
            </div>
            <div class="chat-widget-header-text">
                <h3>Ask AI</h3>
                <p>Powered by GitHub Copilot</p>
            </div>
        </div>
        <div class="chat-widget-messages" id="widgetMessages">
            <div class="chat-welcome">
                <p>üëã Ask me about VS Code contributors!</p>
                <div class="suggested-questions">
                    <button class="suggestion-btn" onclick="widgetAsk('Who are the top contributors?')">Top contributors</button>
                    <button class="suggestion-btn" onclick="widgetAsk('What releases are available?')">Available releases</button>
                </div>
            </div>
        </div>
        <form class="chat-widget-input" onsubmit="return handleWidgetSubmit(event)">
            <div class="chat-input-wrapper">
                <input type="text" id="widgetInput" class="chat-input" placeholder="Ask a question..." autocomplete="off" />
                <button type="submit" class="chat-send-btn" id="widgetSendBtn">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M1.724 1.053a.5.5 0 00-.714.545l1.403 4.85a.5.5 0 00.397.354l5.69.953c.268.053.268.437 0 .49l-5.69.953a.5.5 0 00-.397.354l-1.403 4.85a.5.5 0 00.714.545l13-6.5a.5.5 0 000-.894l-13-6.5z"/>
                    </svg>
                </button>
            </div>
        </form>
    </div>

    <script>
        // Chat widget functionality
        const widgetTrigger = document.getElementById('chatWidgetTrigger');
        const widgetPanel = document.getElementById('chatWidgetPanel');
        const widgetMessages = document.getElementById('widgetMessages');
        const widgetInput = document.getElementById('widgetInput');
        const widgetSendBtn = document.getElementById('widgetSendBtn');
        let widgetLoading = false;

        widgetTrigger.addEventListener('click', () => {
            const isOpen = widgetPanel.classList.toggle('open');
            widgetTrigger.classList.toggle('active', isOpen);
            if (isOpen) widgetInput.focus();
        });

        function addWidgetMessage(content, isUser) {
            const welcome = widgetMessages.querySelector('.chat-welcome');
            if (welcome) welcome.style.display = 'none';
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message ${isUser ? 'user' : 'assistant'}`;
            msgDiv.innerHTML = `<div class="message-content">${isUser ? escapeHtmlWidget(content) : content}</div>`;
            widgetMessages.appendChild(msgDiv);
            widgetMessages.scrollTop = widgetMessages.scrollHeight;
        }

        function escapeHtmlWidget(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function addWidgetLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message assistant';
            loadingDiv.id = 'widgetLoading';
            loadingDiv.innerHTML = '<div class="message-content"><div class="typing-indicator"><span></span><span></span><span></span></div></div>';
            widgetMessages.appendChild(loadingDiv);
            widgetMessages.scrollTop = widgetMessages.scrollHeight;
        }

        function removeWidgetLoading() {
            const loading = document.getElementById('widgetLoading');
            if (loading) loading.remove();
        }

        async function widgetAsk(query) {
            if (widgetLoading || !query.trim()) return;
            widgetLoading = true;
            widgetSendBtn.disabled = true;
            widgetInput.value = '';
            
            addWidgetMessage(query, true);
            addWidgetLoading();
            
            try {
                const resp = await fetch('/api/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                removeWidgetLoading();
                if (!resp.ok) throw new Error('Request failed');
                const data = await resp.json();
                addWidgetMessage(data.answer || 'Sorry, I could not process that.', false);
            } catch (e) {
                removeWidgetLoading();
                addWidgetMessage('Sorry, something went wrong.', false);
            } finally {
                widgetLoading = false;
                widgetSendBtn.disabled = false;
                widgetInput.focus();
            }
        }

        function handleWidgetSubmit(e) {
            e.preventDefault();
            widgetAsk(widgetInput.value);
            return false;
        }
    </script>
</body>
</html>
