<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask AI - VS Code Contributors</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <nav>
        <a href="/" class="nav-brand">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M29.01,5.03,23.244,2.254a1.742,1.742,0,0,0-1.989.338L2.38,19.8A1.166,1.166,0,0,0,2.3,21.447c.025.027.05.053.077.077l1.541,1.4a1.165,1.165,0,0,0,1.489.066L28.142,5.75A1.158,1.158,0,0,1,30,6.672V6.605A1.748,1.748,0,0,0,29.01,5.03Z" style="fill:#0065a9"/><path d="M29.01,26.97l-5.766,2.777a1.745,1.745,0,0,1-1.989-.338L2.38,12.2A1.166,1.166,0,0,1,2.3,10.553c.025-.027.05-.053.077-.077l1.541-1.4A1.165,1.165,0,0,1,5.41,9.01L28.142,26.25A1.158,1.158,0,0,0,30,25.328V25.4A1.749,1.749,0,0,1,29.01,26.97Z" style="fill:#007acc"/><path d="M23.244,29.747a1.745,1.745,0,0,1-1.989-.338A1.025,1.025,0,0,0,23,28.684V3.316a1.024,1.024,0,0,0-1.749-.724,1.744,1.744,0,0,1,1.989-.339l5.765,2.772A1.748,1.748,0,0,1,30,6.6V25.4a1.748,1.748,0,0,1-.991,1.576Z" style="fill:#1f9cf0"/></svg>
            <span>VS Code Contributors</span>
        </a>
        <a href="/" class="nav-link">Home</a>
        <a href="/contributors" class="nav-link">Contributors</a>
        <a href="/leaderboard" class="nav-link">Leaderboard</a>
        <a href="/ask" class="nav-link active">Ask AI</a>
        <a href="/about" class="nav-link">About</a>
        <span class="spacer"></span>
        <form action="/search" method="GET" class="nav-search-form">
            <input type="text" name="q" placeholder="Search contributors..." class="nav-search-input">
        </form>
        <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
            <span id="theme-icon">‚òÄÔ∏è</span> <span id="theme-label">Light</span>
        </button>
    </nav>

    <main class="wide">
        <div class="ask-container">
            <div class="ask-header reveal">
                <div class="ask-icon">
                    <svg width="32" height="32" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 0a8 8 0 100 16A8 8 0 008 0zM5.5 4.002h5a.5.5 0 01.5.5v5a.5.5 0 01-.5.5h-2v2.498a.5.5 0 01-.854.354L4.646 9.854A.5.5 0 014.5 9.5v-5a.5.5 0 01.5-.5l.5.002z"/>
                    </svg>
                </div>
                <h1>Ask AI about VS Code Contributors</h1>
                <p class="ask-subtitle">Powered by GitHub Copilot. Ask questions about contributors, releases, pull requests, and more.</p>
            </div>

            <div class="chat-container reveal reveal-delay-1">
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-welcome">
                        <p>üëã Hi! I can help you explore VS Code contributor data. Try asking:</p>
                        <div class="suggested-questions">
                            <button class="suggestion-btn" onclick="askQuestion('Who are the top contributors to VS Code?')">Who are the top contributors?</button>
                            <button class="suggestion-btn" onclick="askQuestion('What releases are available?')">What releases are available?</button>
                            <button class="suggestion-btn" onclick="askQuestion('Show me contributors from the latest release')">Latest release contributors</button>
                        </div>
                    </div>
                </div>

                <form class="chat-input-form" id="chatForm" onsubmit="handleSubmit(event)">
                    <div class="chat-input-wrapper">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Ask about contributors, releases, PRs..." autocomplete="off" />
                        <button type="submit" class="chat-send-btn" id="sendBtn">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M1.724 1.053a.5.5 0 00-.714.545l1.403 4.85a.5.5 0 00.397.354l5.69.953c.268.053.268.437 0 .49l-5.69.953a.5.5 0 00-.397.354l-1.403 4.85a.5.5 0 00.714.545l13-6.5a.5.5 0 000-.894l-13-6.5z"/>
                            </svg>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-inner">
            <div class="footer-left">
                <span class="status-dot"></span>
                <span>Built with care</span>
            </div>
            <div class="footer-right">
                Data sourced from <a href="https://code.visualstudio.com/updates" target="_blank" rel="noopener">VS Code Release Notes</a>
            </div>
        </div>
    </footer>

    <script>
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateToggleUI(next);
        }
        function updateToggleUI(theme) {
            document.getElementById('theme-icon').textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            document.getElementById('theme-label').textContent = theme === 'light' ? 'Dark' : 'Light';
        }
        (function() {
            const saved = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
            updateToggleUI(saved);
        })();

        // Scroll reveal
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });
        document.querySelectorAll('.reveal').forEach(el => observer.observe(el));

        // Chat functionality
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        let isLoading = false;

        function addMessage(content, isUser) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message ${isUser ? 'user' : 'assistant'}`;
            
            if (isUser) {
                msgDiv.innerHTML = `<div class="message-content">${escapeHtml(content)}</div>`;
            } else {
                msgDiv.innerHTML = `<div class="message-content">${renderMarkdown(content)}</div>`;
            }
            
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addLoadingIndicator() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message assistant loading';
            loadingDiv.id = 'loadingIndicator';
            loadingDiv.innerHTML = `
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeLoadingIndicator() {
            const loading = document.getElementById('loadingIndicator');
            if (loading) loading.remove();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderMarkdown(text) {
            // Basic markdown rendering
            return text
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
                .replace(/^### (.+)$/gm, '<h4>$1</h4>')
                .replace(/^## (.+)$/gm, '<h3>$1</h3>')
                .replace(/^# (.+)$/gm, '<h2>$1</h2>')
                .replace(/^- (.+)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                .replace(/<\/ul>\s*<ul>/g, '')
                .replace(/\n/g, '<br>');
        }

        async function askQuestion(query) {
            if (isLoading || !query.trim()) return;
            
            // Hide welcome message on first question
            const welcome = document.querySelector('.chat-welcome');
            if (welcome) welcome.style.display = 'none';
            
            isLoading = true;
            sendBtn.disabled = true;
            chatInput.value = '';
            
            addMessage(query, true);
            addLoadingIndicator();
            
            try {
                const response = await fetch('/api/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                
                removeLoadingIndicator();
                
                if (!response.ok) {
                    throw new Error(`Request failed: ${response.status}`);
                }
                
                const data = await response.json();
                addMessage(data.answer || 'Sorry, I could not process that request.', false);
            } catch (error) {
                removeLoadingIndicator();
                addMessage('Sorry, something went wrong. Please try again.', false);
                console.error('Ask error:', error);
            } finally {
                isLoading = false;
                sendBtn.disabled = false;
                chatInput.focus();
            }
        }

        function handleSubmit(event) {
            event.preventDefault();
            askQuestion(chatInput.value);
        }

        // Focus input on load
        chatInput.focus();
    </script>
</body>
</html>
