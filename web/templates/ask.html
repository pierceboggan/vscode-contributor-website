<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask AI - VS Code Contributors</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <nav>
        <a href="/" class="nav-brand">
            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg"><mask id="a" mask-type="alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="100" height="100"><path fill-rule="evenodd" clip-rule="evenodd" d="M70.912 99.317a6.85 6.85 0 0 0 4.97-.642l20.159-10.216A6.86 6.86 0 0 0 99.717 82.5V17.5a6.859 6.859 0 0 0-3.676-5.96L75.882 1.325a6.852 6.852 0 0 0-7.81 1.074l-43.34 39.58L10.47 30.32a4.574 4.574 0 0 0-5.833.393L.673 34.542a4.573 4.573 0 0 0-.005 6.588l12.36 11.345L.668 63.82a4.573 4.573 0 0 0 .005 6.588l3.964 3.83a4.573 4.573 0 0 0 5.833.392l14.261-11.66 43.34 39.582a6.844 6.844 0 0 0 2.841 1.765ZM75.025 27.18 45.011 50l30.014 22.82V27.18Z" fill="#fff"/></mask><g mask="url(#a)"><path d="M96.041 11.54 75.882 1.325a6.856 6.856 0 0 0-7.81 1.074L.668 58.862a4.573 4.573 0 0 0 .005 6.588l3.964 3.83a4.573 4.573 0 0 0 5.833.392L96.21 7.124A4.573 4.573 0 0 0 96.04 11.54Z" fill="#0065A9"/><g filter="url(#b)"><path d="M96.041 88.46 75.882 98.675a6.856 6.856 0 0 1-7.81-1.074L.668 41.138a4.573 4.573 0 0 1 .005-6.588l3.964-3.83a4.573 4.573 0 0 1 5.833-.392l85.74 62.548a4.573 4.573 0 0 1-.17 4.584Z" fill="#007ACC"/></g><g filter="url(#c)"><path d="M75.882 98.675A6.849 6.849 0 0 1 68.072 97.6a5.26 5.26 0 0 0 3.602 2.117 5.26 5.26 0 0 0 4.021-1.01l20.16-10.216a6.857 6.857 0 0 0 3.675-5.96V17.5a6.857 6.857 0 0 0-3.676-5.96L75.695 1.326A5.257 5.257 0 0 0 68.072 2.4 6.849 6.849 0 0 1 75.882 1.3l20.16 10.216A6.86 6.86 0 0 1 99.716 17.5v65a6.86 6.86 0 0 1-3.676 5.96l-20.159 10.215Z" fill="#1F9CF0"/></g><g opacity=".25"><path fill-rule="evenodd" clip-rule="evenodd" d="M70.852 99.317a6.851 6.851 0 0 0 4.97-.642l20.159-10.216a6.86 6.86 0 0 0 3.676-5.96V17.5a6.859 6.859 0 0 0-3.676-5.96L75.822 1.326a6.852 6.852 0 0 0-7.81 1.074L24.673 41.98 10.41 30.32a4.574 4.574 0 0 0-5.833.393L.613 34.542a4.573 4.573 0 0 0-.005 6.588l12.36 11.345-12.36 11.345a4.573 4.573 0 0 0 .005 6.588l3.964 3.83a4.573 4.573 0 0 0 5.833.392l14.262-11.66 43.339 39.582a6.845 6.845 0 0 0 2.841 1.765Zm4.113-72.137L44.951 50l30.014 22.82V27.18Z" fill="url(#d)"/></g></g><defs><filter id="b" x="-8.398" y="22.654" width="115.504" height="84.092" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB"><feFlood flood-opacity="0" result="A"/><feColorMatrix in="SourceAlpha" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="B"/><feOffset/><feGaussianBlur stdDeviation="4.167"/><feColorMatrix values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/><feBlend in2="A" result="C"/><feBlend in="SourceGraphic" in2="C"/></filter><filter id="c" x="60.427" y="-6.746" width="47.289" height="113.492" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB"><feFlood flood-opacity="0" result="A"/><feColorMatrix in="SourceAlpha" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="B"/><feOffset/><feGaussianBlur stdDeviation="4.167"/><feColorMatrix values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/><feBlend in2="A" result="C"/><feBlend in="SourceGraphic" in2="C"/></filter><linearGradient id="d" x1="49.948" y1=".823" x2="49.948" y2="99.137" gradientUnits="userSpaceOnUse"><stop stop-color="#fff"/><stop offset="1" stop-color="#fff" stop-opacity="0"/></linearGradient></defs></svg>
            <span>VS Code Contributors</span>
        </a>
        <a href="/" class="nav-link">Home</a>
        <a href="/contributors" class="nav-link">Contributors</a>
        <a href="/leaderboard" class="nav-link">Leaderboard</a>
        <a href="/ask" class="nav-link active">Ask AI</a>
        <a href="/about" class="nav-link">About</a>
        <span class="spacer"></span>
        <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
            <span id="theme-icon">‚òÄÔ∏è</span> <span id="theme-label">Light</span>
        </button>
    </nav>

    <main class="wide">
        <div class="ask-container">
            <div class="ask-header reveal">
                <div class="ask-icon">
                    <svg width="32" height="32" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M8 0a8 8 0 100 16A8 8 0 008 0zM5.5 4.002h5a.5.5 0 01.5.5v5a.5.5 0 01-.5.5h-2v2.498a.5.5 0 01-.854.354L4.646 9.854A.5.5 0 014.5 9.5v-5a.5.5 0 01.5-.5l.5.002z"/>
                    </svg>
                </div>
                <h1>Ask AI about VS Code Contributors</h1>
                <p class="ask-subtitle">Powered by GitHub Copilot. Ask questions about contributors, releases, pull requests, and more.</p>
            </div>

            <div class="chat-container reveal reveal-delay-1">
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-welcome">
                        <p>üëã Hi! I can help you explore VS Code contributor data. Try asking:</p>
                        <div class="suggested-questions">
                            <button class="suggestion-btn" onclick="askQuestion('Who are the top contributors to VS Code?')">Who are the top contributors?</button>
                            <button class="suggestion-btn" onclick="askQuestion('What releases are available?')">What releases are available?</button>
                            <button class="suggestion-btn" onclick="askQuestion('Show me contributors from the latest release')">Latest release contributors</button>
                        </div>
                    </div>
                </div>

                <form class="chat-input-form" id="chatForm" onsubmit="handleSubmit(event)">
                    <div class="chat-input-wrapper">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Ask about contributors, releases, PRs..." autocomplete="off" />
                        <button type="submit" class="chat-send-btn" id="sendBtn">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M1.724 1.053a.5.5 0 00-.714.545l1.403 4.85a.5.5 0 00.397.354l5.69.953c.268.053.268.437 0 .49l-5.69.953a.5.5 0 00-.397.354l-1.403 4.85a.5.5 0 00.714.545l13-6.5a.5.5 0 000-.894l-13-6.5z"/>
                            </svg>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-inner">
            <div class="footer-left">
                <span class="status-dot"></span>
                <span>Built with care</span>
            </div>
            <div class="footer-right">
                Data sourced from <a href="https://code.visualstudio.com/updates" target="_blank" rel="noopener">VS Code Release Notes</a>
            </div>
        </div>
    </footer>

    <script>
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateToggleUI(next);
        }
        function updateToggleUI(theme) {
            document.getElementById('theme-icon').textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            document.getElementById('theme-label').textContent = theme === 'light' ? 'Dark' : 'Light';
        }
        (function() {
            const saved = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
            updateToggleUI(saved);
        })();

        // Scroll reveal
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });
        document.querySelectorAll('.reveal').forEach(el => observer.observe(el));

        // Chat functionality
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        let isLoading = false;

        function addMessage(content, isUser) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message ${isUser ? 'user' : 'assistant'}`;
            
            if (isUser) {
                msgDiv.innerHTML = `<div class="message-content">${escapeHtml(content)}</div>`;
            } else {
                msgDiv.innerHTML = `<div class="message-content">${renderMarkdown(content)}</div>`;
            }
            
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addLoadingIndicator() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message assistant loading';
            loadingDiv.id = 'loadingIndicator';
            loadingDiv.innerHTML = `
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeLoadingIndicator() {
            const loading = document.getElementById('loadingIndicator');
            if (loading) loading.remove();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderMarkdown(text) {
            // Basic markdown rendering
            return text
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
                .replace(/^### (.+)$/gm, '<h4>$1</h4>')
                .replace(/^## (.+)$/gm, '<h3>$1</h3>')
                .replace(/^# (.+)$/gm, '<h2>$1</h2>')
                .replace(/^- (.+)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
                .replace(/<\/ul>\s*<ul>/g, '')
                .replace(/\n/g, '<br>');
        }

        async function askQuestion(query) {
            if (isLoading || !query.trim()) return;
            
            // Hide welcome message on first question
            const welcome = document.querySelector('.chat-welcome');
            if (welcome) welcome.style.display = 'none';
            
            isLoading = true;
            sendBtn.disabled = true;
            chatInput.value = '';
            
            addMessage(query, true);
            addLoadingIndicator();
            
            try {
                const response = await fetch('/api/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                
                removeLoadingIndicator();
                
                if (!response.ok) {
                    throw new Error(`Request failed: ${response.status}`);
                }
                
                const data = await response.json();
                addMessage(data.answer || 'Sorry, I could not process that request.', false);
            } catch (error) {
                removeLoadingIndicator();
                addMessage('Sorry, something went wrong. Please try again.', false);
                console.error('Ask error:', error);
            } finally {
                isLoading = false;
                sendBtn.disabled = false;
                chatInput.focus();
            }
        }

        function handleSubmit(event) {
            event.preventDefault();
            askQuestion(chatInput.value);
        }

        // Focus input on load
        chatInput.focus();
    </script>
</body>
</html>
